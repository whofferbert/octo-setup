#!/bin/sh
# postinst script for test
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see https://www.debian.org/doc/debian-policy/ or
# the debian-policy package

# want user pi by default
want_user=pi

# if wanted user does not have home, find a better user
if [ -n "`grep -Pom1 "^$want_user(?=:.*/home/)" /etc/passwd`" ] ; then
    user=$want_user
else
    # grab first user from /etc/passwd with a profile in /home
    user=`grep -Pom1 '^[^:]+(?=:.*/home/)' /etc/passwd`
fi

# find users home dir
user_home=`eval ls -1d ~$user`

if [ -z "$user" ] ; then
    echo "Unable to figure out install user!"
    exit 2
fi

if [ -z "$user_home" ] ; then
    echo "Unable to find home dir for $user!"
    exit 2
fi

case "$1" in
    configure)
    echo updating the kernel
	sudo rpi-update

	export DATE=`date +%Y-%m-%d.%H.%M.%S`
	echo setting up /boot/config.txt
	config_BACKUP_FN=/boot/config.txt.$DATE
	echo backing up /boot/config.txt to $config_BACKUP_FN
	cp /boot/config.txt $config_BACKUP_FN
	# check the device tree overlay is setup correctly ...
	# firstly disable PWM audio
	sed -i "s/^\s*dtparam=audio/#dtparam=audio/" /boot/config.txt
	# remove any previous mentions of the octo overlay
	sed -i "/AudioInjector/d" /boot/config.txt
	sed -i "/audioinjector-addons/d" /boot/config.txt
	echo setting up /boot/config.txt
	# now check to see the correct device tree overlay is loaded ...
	echo '# enable the AudioInjector.net sound card
dtoverlay=audioinjector-addons' >> /boot/config.txt

	ASOUNDRC_BACKUP_FN=/etc/asound.conf.$DATE
	echo backing up /etc/asound.conf to $ASOUNDRC_BACKUP_FN
	[ -f /etc/asound.conf ] && sudo mv /etc/asound.conf $ASOUNDRC_BACKUP_FN
	ASOUNDRC_BACKUP_FN=~/.asoundrc.$DATE
	echo backing up ~/.asoundrc to $ASOUNDRC_BACKUP_FN
	[ -f ~/.asoundrc ] && mv ~/.asoundrc $ASOUNDRC_BACKUP_FN
	ASOUNDRC_BACKUP_FN=$user_home/.asoundrc.$DATE
	echo backing up $user_home/.asoundrc to $ASOUNDRC_BACKUP_FN
	[ -f $user_home/.asoundrc ] && mv $user_home/.asoundrc $ASOUNDRC_BACKUP_FN

	echo 'pcm.!default {
#       type hw
#       card 0
        type plug
        slave.pcm "anyChannelCount"
}

ctl.!default {
        type hw
        card 0
}

pcm.anyChannelCount {
    type route
    slave.pcm "hw:0"
    slave.channels 8;
    ttable {
           0.0 1
           1.1 1
           2.2 1
           3.3 1
           4.4 1
           5.5 1
           6.6 1
           7.7 1
    }
}

ctl.anyChannelCount {
    type hw;
    card 0;
}' > /tmp/asound.conf

echo 'pcm.!default {
#       type hw
#       card 0
        type plug
        slave.pcm "anyChannelCount"
}

ctl.!default {
        type hw
        card 0
}' > $user_home/.asoundrc

	sudo mv /tmp/asound.conf /etc/asound.conf

  panel_file=$user_home/.config/lxpanel/LXDE-pi/panels/panel

  if [ -e $panel_file ]; then
	   echo lxpanel\'s volume plugin is disfunctional, disabling it
	    sed -i 's/\=volumealsa/\=REMOVEvolumealsa/' $panel_file
      echo
      echo pulse gets in the way we suggest you remove it, please run the following manually :
      echo sudo apt remove pulseaudio
  fi

    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
